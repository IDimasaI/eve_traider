use serde_json::{Value, json};
use std::process::Command;
use wry::application::window::WindowBuilder;
use wry::webview::WebViewBuilder;

fn main() -> wry::Result<()> {
    let event_loop = wry::application::event_loop::EventLoop::new();
    let window = WindowBuilder::new()
        .with_title("EVE Price Tracker")
        .build(&event_loop)?;

    // –ü—É—Ç—å –∫ –æ–±–Ω–æ–≤–ª—è—Ç–µ–ª—é –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤ –∑–∞–º—ã–∫–∞–Ω–∏–µ
    let updater_path = std::path::PathBuf::from("./updater.exe");

    let _webview = WebViewBuilder::new(window)?
        .with_url("http://localhost:6969")?
        .with_ipc_handler(move |request| {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ JavaScript
            let message = request.body();
            println!("üì® –ü–æ–ª—É—á–µ–Ω–æ IPC —Å–æ–æ–±—â–µ–Ω–∏–µ: {}", message);

            // –ü–∞—Ä—Å–∏–º JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
            match parse_ipc_message(message) {
                Ok(IpcCommand::CheckUpdate { silent }) => {
                    println!("üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π");

                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç–µ–ª—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                    let updater = updater_path.clone();
                    std::thread::spawn(move || {
                        let result = Command::new(&updater).arg("--check").output();

                        match result {
                            Ok(output) => {
                                let status = if output.status.success() {
                                    "available"
                                } else {
                                    "none"
                                };
                                println!("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {}", status);

                                // –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –≤ JS –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å window –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
                            }
                            Err(e) => eprintln!("–û—à–∏–±–∫–∞: {}", e),
                        }
                    });
                }

                Ok(IpcCommand::InstallUpdate { version }) => {
                    println!("üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–∏: {}", version);

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
                    #[cfg(target_os = "windows")]
                    let _ = Command::new("cmd")
                        .args(&["/C", "start", "updater.exe", "--install", &version])
                        .spawn();

                    #[cfg(not(target_os = "windows"))]
                    let _ = Command::new("./updater.exe")
                        .arg("--install")
                        .arg(&version)
                        .spawn();
                }

                Ok(IpcCommand::ExecuteCommand { cmd, args }) => {
                    // –í–ê–ñ–ù–û: –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!
                    let allowed_commands = ["notepad", "calc", "explorer"];
                    if allowed_commands.contains(&cmd.as_str()) {
                        let _ = Command::new(cmd).args(args).spawn();
                    }
                }

                Err(e) => eprintln!("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {}", e),
            }
        })
        .build()?;

    event_loop.run(move |event, _, control_flow| {
        *control_flow = tao::event_loop::ControlFlow::Wait;
        match event {
            tao::event::Event::WindowEvent {
                event: tao::event::WindowEvent::CloseRequested,
                ..
            } => *control_flow = tao::event_loop::ControlFlow::Exit,
            _ => (),
        }
    });
}

// –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥
#[derive(Debug, serde::Deserialize)]
#[serde(tag = "type", content = "data")]
enum IpcCommand {
    CheckUpdate { silent: bool },
    InstallUpdate { version: String },
    ExecuteCommand { cmd: String, args: Vec<String> },
}

fn parse_ipc_message(msg: &str) -> Result<IpcCommand, serde_json::Error> {
    serde_json::from_str(msg)
}
